<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Creating linked page…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; padding:24px}
    .card{max-width:720px;margin:48px auto;padding:20px;border-radius:10px;background:#fff;box-shadow:0 6px 20px rgba(15,23,42,0.06)}
    .muted{color:#6b7280}
  </style>
</head>
<body>
  <div class="card">
    <h2>Opening linked page…</h2>
    <p class="muted">Please wait while we create or find the linked Confluence page. You will be redirected shortly.</p>
    <p id="status"></p>
  </div>

  <script>
    (async function(){
      const params = new URLSearchParams(location.search);
      const itemId = params.get('itemId');
  const spaceId = params.get('spaceId');
  const spaceKey = params.get('spaceKey');
      const title = params.get('title') || '';
      const statusEl = document.getElementById('status');
      if(!itemId || !spaceId){ statusEl.textContent = 'Missing itemId or spaceId'; return; }

      statusEl.textContent = 'Contacting migration app…';

      try{
        // POST to the Forge resolver endpoint - same origin when served from the app
        const body = { itemId, title };
        if (spaceId) body.spaceId = spaceId;
        if (spaceKey) body.spaceKey = spaceKey;
        const res = await fetch('/_/api/ensurePageForItem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const j = await res.json();

  // Response shapes varied historically. Normalize possible locations for the generated URL:
        // 1) { ok:true, webui: '/wiki/...' }
        // 2) { ok:true, page: { id, webui } }
        // 3) { ok:true, action:'ensured', page: { ok:true, id, webui } }

        const pageObj = (j && j.page) ? j.page : j;
        const webui = pageObj && (pageObj.webui || (pageObj._links && pageObj._links.webui));
        const pageId = pageObj && (pageObj.id || pageObj.pageId);

        // If resolver supplied a fully-qualified URL, prefer it
        const absoluteFromResp = (j && j.url) || (pageObj && pageObj.url);
        if (absoluteFromResp) {
          location.replace(absoluteFromResp);
          return;
        }

        // If resolver supplied base + webui, use that
        const baseFromResp = (j && j.base) || (pageObj && pageObj.base);
        if (baseFromResp && webui) {
          location.replace(baseFromResp + webui);
          return;
        }

        if (webui) {
          // If webui is a relative path, build absolute URL from current host as last resort
          let url = webui;
          if (url.startsWith('/')) {
            url = location.origin + url;
          }
          location.replace(url);
          return;
        }

        // Fallback: if we at least have a pageId, show a link so the user can open it.
        if (pageId) {
          statusEl.innerHTML = 'Page created (id=' + String(pageId) + '). <a href="/wiki/pages/' + encodeURIComponent(String(pageId)) + '">Open page</a>';
          return;
        }

        statusEl.textContent = 'Error: ' + (j && (j.error || JSON.stringify(j)));
      }catch(e){
        statusEl.textContent = 'Request failed: ' + e.message;
      }
    })();
  </script>
</body>
</html>
